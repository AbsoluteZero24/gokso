{{ define "maintenance/laptop" }}
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  .table-maintenance {
    border-collapse: separate !important;
    border-spacing: 0 !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 10px !important;
    overflow: hidden !important;
    margin-bottom: 2rem;
  }
  .table-maintenance thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #0d6efd !important;
    font-weight: 600;
    color: #333;
    padding: 12px;
    text-align: center;
    vertical-align: middle;
  }
  .table-maintenance tbody td {
    border: 1px solid #dee2e6 !important;
    padding: 10px;
    vertical-align: middle;
  }
  .sub-dept-header {
    background-color: #e9ecef;
    font-weight: bold;
    padding: 10px 15px;
    border-left: 5px solid #0d6efd;
    margin-bottom: 10px;
    margin-top: 20px;
    border-radius: 4px;
  }
</style>

<div class="app-content-header d-print-none">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6"><h3 class="mb-0">{{ .title }}</h3></div>
      <div class="col-sm-6 text-end">
        <a href="/maintenance/history" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-clock-history"></i> Lihat Riwayat Laporan
        </a>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid">
    
    <!-- FILTERS -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form action="/maintenance/laptop" method="GET" id="filterForm">
           <div class="row g-3 mb-3 align-items-end">
              <div class="col-md-2">
                 <label class="form-label small fw-bold">Tahun</label>
                  <div class="input-group input-group-sm shadow-sm rounded-2 overflow-hidden border">
                    <span class="input-group-text bg-white border-0 py-0"><i class="bi bi-calendar3 text-primary"></i></span>
                    <select name="year" class="form-select border-0 fw-semibold" style="box-shadow: none;" onchange="this.form.submit()">
                       <option value="">-- Tahun --</option>
                       {{ range $y := .years }}
                       <option value="{{ $y }}" {{ if eq $.currentYear (printf "%d" $y) }}selected{{ end }}>Tahun {{ $y }}</option>
                       {{ end }}
                    </select>
                  </div>
              </div>
              <div class="col-md-2">
                 <label class="form-label small fw-bold">Semester</label>
                 <select name="semester" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="S1" {{ if eq .currentSemester "S1" }}selected{{ end }}>Semester 1</option>
                    <option value="S2" {{ if eq .currentSemester "S2" }}selected{{ end }}>Semester 2</option>
                 </select>
              </div>
               <div class="col text-end">
                  {{ if and .currentBranch .currentDept .currentSubDept }}
                    <button type="button" class="btn btn-warning btn-sm fw-bold" onclick="if(confirm('Ajukan laporan ini untuk tanda tangan? Data akan diarsipkan ke history.')) document.getElementById('form-submit-maintenance').submit()">
                        <i class="bi bi-send-fill me-1"></i> Ajukan Laporan
                    </button>
                  {{ else }}
                    <small class="text-danger">* Pilih Cabang, Bagian & Sub Bagian untuk mengajukan laporan</small>
                  {{ end }}
               </div>
            </div>
           
           <div class="row g-3">
              <div class="col-md-4">
                 <label class="form-label small fw-bold">Cabang</label>
                 <select id="branch_select" class="form-select form-select-sm" onchange="updateDepartments()">
                    <option value="">-- Pilih Cabang --</option>
                    {{ range .branches }}
                    <option value="{{ .Name }}" {{ if eq $.currentBranch .Name }}selected{{ end }}>{{ .Name }}</option>
                    {{ end }}
                 </select>
                 <input type="hidden" name="branch" id="input_branch" value="{{ .currentBranch }}">
              </div>
              <div class="col-md-4">
                 <label class="form-label small fw-bold">Bagian</label>
                 <select name="department" id="department" class="form-select form-select-sm" onchange="updateSubDepartments()">
                    <option value="">-- Pilih Bagian --</option>
                 </select>
              </div>
              <div class="col-md-4">
                 <label class="form-label small fw-bold">Sub Bagian</label>
                 <select name="sub_department" id="sub_department" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Pilih Sub Bagian --</option>
                 </select>
              </div>
           </div>
        </form>

         <!-- Grouped Action Forms -->
         <form action="/maintenance/submit" method="POST" id="form-submit-maintenance" class="d-none">
            <input type="hidden" name="period" value="{{ .period }}">
            <input type="hidden" name="year" value="{{ .currentYear }}">
            <input type="hidden" name="semester" value="{{ .currentSemester }}">
            <input type="hidden" name="branch" value="{{ .currentBranch }}">
            <input type="hidden" name="department" value="{{ .currentDept }}">
            <input type="hidden" name="sub_department" value="{{ .currentSubDept }}">
            <input type="hidden" name="category" value="{{ if eq .title "Laporan Pemeliharaan Laptop" }}Laptop{{ else }}Komputer{{ end }}">
         </form>
      </div>
    </div>

    <!-- ACTIVE CHECKLIST CONTENT -->
    <div class="web-only">
      <div class="text-center mb-4">
         <h4>DAFTAR PEMELIHARAAN ASET</h4>
         <h5 class="text-muted small">Periode: {{ if eq .currentSemester "S1" }}Semester 1{{ else }}Semester 2{{ end }} - {{ .currentYear }}</h5>
      </div>

      {{ range $subDept, $assets := .groupedAssets }}
         <div class="sub-dept-header">Sub Bagian: {{ $subDept }}</div>
         <div class="table-responsive">
            <table class="table table-bordered table-maintenance bg-white">
               <thead>
                  <tr>
                     <th style="width: 40px">No</th>
                     <th>Nama User</th>
                     <th>Jabatan</th>
                     <th>Label Aset</th>
                     <th>Antivirus Update</th>
                     <th>Clear Temp</th>
                     <th>Kondisi</th>
                     <th>Tanggal Periksa</th>
                     <th>Keterangan</th>
                     <th style="width: 50px">Aksi</th>
                  </tr>
               </thead>
               <tbody>
                  {{ range $idx, $item := $assets }}
                  <tr>
                     <td class="text-center">{{ add $idx 1 }}</td>
                     <td>{{ if $item.HasReport }}{{ $item.Report.UserName }}{{ else }}{{ $item.Asset.User.Name }}{{ end }}</td>
                     <td>{{ if $item.HasReport }}{{ $item.Report.UserPosition }}{{ else }}{{ $item.Asset.User.Position }}{{ end }}</td>
                     <td>
                        <small class="text-muted d-block">{{ $item.Asset.InventoryNumber }}</small>
                        <strong>{{ $item.Asset.DeviceName }}</strong>
                     </td>
                     <td class="text-center">
                        {{ if $item.HasReport }}
                           {{ if $item.Report.AntivirusUpdated }}<i class="bi bi-check-circle-fill text-success"></i>{{ else }}<i class="bi bi-x-circle-fill text-danger"></i>{{ end }}
                        {{ else }}-{{ end }}
                     </td>
                     <td class="text-center">
                        {{ if $item.HasReport }}
                           {{ if $item.Report.ClearTemporary }}<i class="bi bi-check-circle-fill text-success"></i>{{ else }}<i class="bi bi-x-circle-fill text-danger"></i>{{ end }}
                        {{ else }}-{{ end }}
                     </td>
                     <td class="text-center">
                        {{ if $item.HasReport }}
                           {{ if eq $item.Report.OverallCondition "Normal" }}
                              <span class="badge bg-success">Normal</span>
                           {{ else }}
                              <span class="badge bg-danger">Tidak Normal</span>
                           {{ end }}
                        {{ else }}
                           <span class="badge bg-secondary">Belum Cek</span>
                        {{ end }}
                     </td>
                     <td class="text-center">{{ if $item.HasReport }}{{ $item.Report.InspectionDate.Format "02/01/2006" }}{{ else }}-{{ end }}</td>
                     <td>{{ if $item.HasReport }}{{ $item.Report.Remarks }}{{ else }}-{{ end }}</td>
                     <td class="text-center">
                        <button class="btn btn-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalMaintenance" 
                                data-bs-asset-id="{{ $item.Asset.ID }}"
                                data-bs-asset-name="{{ $item.Asset.DeviceName }} ({{ $item.Asset.InventoryNumber }})"
                                data-bs-antivirus="{{ if $item.HasReport }}{{ $item.Report.AntivirusUpdated }}{{ else }}false{{ end }}"
                                data-bs-cleartemp="{{ if $item.HasReport }}{{ $item.Report.ClearTemporary }}{{ else }}false{{ end }}"
                                data-bs-condition="{{ if $item.HasReport }}{{ $item.Report.OverallCondition }}{{ else }}Normal{{ end }}"
                                data-bs-date="{{ if $item.HasReport }}{{ $item.Report.InspectionDate.Format "2006-01-02" }}{{ end }}"
                                data-bs-remarks="{{ if $item.HasReport }}{{ $item.Report.Remarks }}{{ end }}">
                           <i class="bi bi-pencil-square"></i>
                        </button>
                     </td>
                  </tr>
                  {{ end }}
               </tbody>
            </table>
         </div>
      {{ else }}
         <div class="alert alert-info py-4 text-center">Tidak ada aset baru yang perlu diperiksa untuk filter ini. Silakan cek Riwayat untuk laporan yang sudah disubmit.</div>
      {{ end }}
    </div>

  </div>
</div>

<!-- Modal Entry Maintenance -->
<div class="modal fade" id="modalMaintenance" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Isi Data Pemeliharaan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/maintenance/laptop/store" method="POST">
        <div class="modal-body">
          <input type="hidden" name="asset_id" id="m_asset_id">
          <input type="hidden" name="period" value="{{ .period }}">
          <input type="hidden" name="branch" value="{{ .currentBranch }}">
          <input type="hidden" name="year" value="{{ .currentYear }}">
          <input type="hidden" name="semester" value="{{ .currentSemester }}">
          <input type="hidden" name="department" value="{{ .currentDept }}">
          <input type="hidden" name="sub_department" value="{{ .currentSubDept }}">
          
          <div class="mb-3">
            <label class="form-label fw-bold">Aset</label>
            <input type="text" class="form-control-plaintext" id="m_asset_name" readonly>
          </div>

          <div class="row">
             <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Antivirus Terupdate?</label>
                <div class="form-check">
                   <input class="form-check-input" type="radio" name="antivirus_updated" id="anti_true" value="true">
                   <label class="form-check-label" for="anti_true">Ya</label>
                </div>
                <div class="form-check">
                   <input class="form-check-input" type="radio" name="antivirus_updated" id="anti_false" value="false" checked>
                   <label class="form-check-label" for="anti_false">Tidak</label>
                </div>
             </div>
             <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Clear Temporary?</label>
                <div class="form-check">
                   <input class="form-check-input" type="radio" name="clear_temporary" id="temp_true" value="true">
                   <label class="form-check-label" for="temp_true">Ya</label>
                </div>
                <div class="form-check">
                   <input class="form-check-input" type="radio" name="clear_temporary" id="temp_false" value="false" checked>
                   <label class="form-check-label" for="temp_false">Tidak</label>
                </div>
             </div>
          </div>

          <div class="mb-3">
             <label for="m_condition" class="form-label fw-bold">Kondisi Keseluruhan</label>
             <select name="overall_condition" id="m_condition" class="form-select">
                <option value="Normal">Normal</option>
                <option value="Tidak Normal">Tidak Normal</option>
             </select>
          </div>

          <div class="mb-3">
             <label for="m_date" class="form-label fw-bold">Tanggal Periksa</label>
             <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="text" name="inspection_date" id="m_date" class="form-control bg-white" placeholder="Pilih Tanggal" required>
             </div>
          </div>

          <div class="mb-3">
             <label for="m_remarks" class="form-label fw-bold">Keterangan</label>
             <textarea name="remarks" id="m_remarks" class="form-control" rows="3" placeholder="Opsional..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan Data</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const masterData = [
    {{ range $branch := .branches }}
    {
      id: "{{ $branch.ID }}",
      name: "{{ $branch.Name }}",
      departments: [
        {{ range $dept := $branch.Departments }}
        {
          id: "{{ $dept.ID }}",
          name: "{{ $dept.Name }}",
          subDepartments: [
            {{ range $sub := $dept.SubDepartments }}
            { id: "{{ $sub.ID }}", name: "{{ $sub.Name }}" },
            {{ end }}
          ]
        },
        {{ end }}
      ]
    },
    {{ end }}
  ];

  function updateDepartments() {
    const branchSelect = document.getElementById('branch_select');
    const deptSelect = document.getElementById('department');
    const subDeptSelect = document.getElementById('sub_department');
    const inputBranch = document.getElementById('input_branch');
    
    const branchName = branchSelect.value;
    inputBranch.value = branchName;
    
    const branch = masterData.find(b => b.name === branchName);
    deptSelect.innerHTML = '<option value="">-- Pilih --</option>';
    subDeptSelect.innerHTML = '<option value="">-- Pilih --</option>';
    
    if (branch && branch.departments) {
      branch.departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.name;
        option.text = dept.name;
        deptSelect.appendChild(option);
      });
    }
  }

  function updateSubDepartments() {
    const branchSelect = document.getElementById('branch_select');
    const deptSelect = document.getElementById('department');
    const subDeptSelect = document.getElementById('sub_department');
    
    const branchName = branchSelect.value;
    const deptName = deptSelect.value;
    
    const branch = masterData.find(b => b.name === branchName);
    const dept = branch ? branch.departments.find(d => d.name === deptName) : null;
    
    subDeptSelect.innerHTML = '<option value="">-- Pilih --</option>';
    
    if (dept && dept.subDepartments) {
      dept.subDepartments.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.name;
        option.text = sub.name;
        subDeptSelect.appendChild(option);
      });
    }
  }

document.addEventListener('DOMContentLoaded', function() {
    const initialBranch = "{{ .currentBranch }}";
    const initialDept = "{{ .currentDept }}";
    const initialSub = "{{ .currentSubDept }}";
    
    if (initialBranch) {
        const branch = masterData.find(b => b.name === initialBranch);
        if (branch) {
            const deptSelect = document.getElementById('department');
            deptSelect.innerHTML = '<option value="">-- Pilih --</option>';
            branch.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.text = dept.name;
                if (dept.name === initialDept) option.selected = true;
                deptSelect.appendChild(option);
            });
            
            const dept = branch.departments.find(d => d.name === initialDept);
            if (dept) {
                const subDeptSelect = document.getElementById('sub_department');
                subDeptSelect.innerHTML = '<option value="">-- Pilih --</option>';
                dept.subDepartments.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.text = sub.name;
                    if (sub.name === initialSub) option.selected = true;
                    subDeptSelect.appendChild(option);
                });
            }
        }
    }

    const fp = flatpickr("#m_date", {
        dateFormat: "Y-m-d",
        allowInput: true,
        static: true
    });

    const modalMaintenance = document.getElementById('modalMaintenance');
    if (modalMaintenance) {
        modalMaintenance.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const assetId = button.getAttribute('data-bs-asset-id');
            const assetName = button.getAttribute('data-bs-asset-name');
            const antivirus = button.getAttribute('data-bs-antivirus');
            const clearTemp = button.getAttribute('data-bs-cleartemp');
            const condition = button.getAttribute('data-bs-condition');
            const date = button.getAttribute('data-bs-date');
            const remarks = button.getAttribute('data-bs-remarks');

            modalMaintenance.querySelector('#m_asset_id').value = assetId;
            modalMaintenance.querySelector('#m_asset_name').value = assetName;
            modalMaintenance.querySelector('#m_condition').value = condition;
            modalMaintenance.querySelector('#m_remarks').value = remarks;
            
            if (date) fp.setDate(date); else fp.setDate(new Date());

            if (antivirus === "true") modalMaintenance.querySelector('#anti_true').checked = true;
            else modalMaintenance.querySelector('#anti_false').checked = true;

            if (clearTemp === "true") modalMaintenance.querySelector('#temp_true').checked = true;
            else modalMaintenance.querySelector('#temp_false').checked = true;
        });
    }
});
</script>
{{ end }}
