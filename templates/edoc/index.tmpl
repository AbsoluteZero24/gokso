{{ define "edoc/index" }}
<style>
    :root {
        --dms-bg: #f8fafc;
        --dms-card: #ffffff;
        --dms-text: #1e293b;
        --dms-text-muted: #64748b;
        --dms-border: #e2e8f0;
        --dms-accent: #3b82f6;
    }

    .dms-container {
        padding: 2rem;
        background: var(--dms-bg);
        min-height: calc(100vh - 60px);
        color: var(--dms-text);
    }

    /* Filter Bar */
    .filter-bar {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 2rem;
    }
    .filter-btn {
        background: white;
        border: 1px solid var(--dms-border);
        padding: 0.4rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        color: var(--dms-text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .filter-btn:hover { background: #f1f5f9; }

    /* Sort Header */
    .sort-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--dms-text);
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    .sort-icon {
        background: #3b82f6;
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }

    /* Folder Grid */
    .folder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 3rem;
    }
    .folder-card {
        background: var(--dms-card);
        padding: 0.85rem 1.25rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--dms-border);
        position: relative;
    }
    .folder-card:hover { border-color: var(--dms-accent); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .folder-card.selected { background: #eff6ff; border-color: var(--dms-accent); }
    
    .folder-icon-img {
        font-size: 1.5rem;
        color: #fbbf24;
    }
    .folder-name-text {
        font-size: 0.95rem;
        font-weight: 500;
        color: #334155;
        flex-grow: 1;
    }

    /* Action Bar */
    .action-bar {
        background: #1e293b;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 50rem;
        display: none;
        align-items: center;
        gap: 1.5rem;
        position: sticky;
        top: 1rem;
        z-index: 100;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    .action-bar.active { display: flex; }

    /* New Menu Dropdown */
    .dropdown-new {
        border-radius: 12px !important;
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        padding: 8px 0 !important;
        min-width: 280px !important;
    }
    .dropdown-new .dropdown-item {
        padding: 10px 20px !important;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        color: #475569;
    }
    .dropdown-new .dropdown-item i { font-size: 1.1rem; }
    .dropdown-new .shortcut { margin-left: auto; color: #94a3b8; font-size: 0.75rem; }

    /* Action Dropdown Fix */
    .dropdown-menu-end {
        right: 0;
        left: auto;
    }
    .dropdown-item i { width: 20px; text-align: center; }
    .dropdown-item.text-danger i { color: #ef4444; }

    /* Float New Button */
    .btn-float-new {
        position: fixed;
        bottom: 30px;
        right: 30px;
        height: 56px;
        padding: 0 24px;
        background: white;
        color: #3b82f6;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        border: none;
        z-index: 1000;
        transition: all 0.2s;
    }
    .btn-float-new:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }

    /* Table Style for Files */
    .file-list-card {
        background: white;
        border: 1px solid var(--dms-border);
        border-radius: 1rem;
    }
    .table-responsive {
        overflow: visible !important;
    }
    .file-table th {
        background: #f8fafc;
        padding: 1rem;
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 600;
        border-bottom: 1px solid var(--dms-border);
    }
    .file-row td { padding: 1.25rem 1rem; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
    .file-row:hover { background: #f8fafc; cursor: pointer; }
    .file-row.selected { background: #eff6ff !important; }
    .file-icon { font-size: 1.25rem; color: #ef4444; }

    /* Selection Styles */
    .selection-indicator {
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e1;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        background: white;
    }
    .selected .selection-indicator {
        background: var(--dms-accent);
        border-color: var(--dms-accent);
    }
    .selected .selection-indicator::after {
        content: "\F26E";
        font-family: "bootstrap-icons";
        color: white;
        font-size: 12px;
    }

    .action-bar-fixed {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #1e293b;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 50rem;
        display: flex;
        align-items: center;
        gap: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .action-bar-fixed.active {
        transform: translateX(-50%) translateY(0);
    }
    .action-btn-bulk {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: none;
        background: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        transition: background 0.2s;
    }
    .action-btn-bulk:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Drag & Drop Overlay */
    .drop-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(30, 41, 59, 0.9);
        backdrop-filter: blur(8px);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
        color: white;
        flex-direction: column;
        gap: 1.5rem;
        pointer-events: none;
        transition: all 0.3s ease;
    }
    .drop-overlay.active {
        display: flex;
    }
    .drop-overlay-icon {
        font-size: 5rem;
        color: var(--dms-accent);
        animation: bounce 1.5s infinite ease-in-out;
    }
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-25px); }
    }
    .upload-progress-container {
        width: 300px;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 1rem;
        display: none;
    }
    .upload-progress-bar {
        width: 0%;
        height: 100%;
        background: var(--dms-accent);
        transition: width 0.3s;
    }
</style>

<div id="dropOverlay" class="drop-overlay">
    <i class="bi bi-cloud-arrow-up-fill drop-overlay-icon"></i>
    <h2 class="fw-bold mb-0">Drop to Upload</h2>
    <p class="text-white-50">Drop files or folders anywhere to start uploading</p>
    <div class="upload-progress-container" id="uploadProgressContainer">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
    </div>
</div>

<div class="dms-container">
    <!-- Action Bar -->
    <div class="dms-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                {{ if not .isTrash }}
                <div class="dropdown">
                    <button class="btn btn-primary rounded-pill px-4 py-2 fw-bold d-flex align-items-center gap-2 shadow-sm" data-bs-toggle="dropdown">
                        <i class="bi bi-plus-lg"></i> New
                    </button>
                    <ul class="dropdown-menu dropdown-new shadow border-0">
                        <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addFolderModal">
                            <i class="bi bi-folder-plus text-warning"></i> New folder
                        </button></li>
                        <li><div class="dropdown-divider"></div></li>
                        <li><button class="dropdown-item" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-file-earmark-arrow-up text-primary"></i> File upload
                        </button></li>
                        <li><button class="dropdown-item" onclick="document.getElementById('folderInput').click()">
                            <i class="bi bi-folder-symlink text-success"></i> Folder upload
                        </button></li>
                    </ul>
                </div>
                {{ end }}
                <h1 class="h3 fw-bold mb-0">eDoc Management</h1>
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="text-end">
                    <div class="small text-muted mb-0">Storage Used</div>
                    <div class="fw-bold">{{ .totalStorage }}</div>
                </div>
                <div class="d-flex gap-2">
                    <a href="/godms/trash" class="btn btn-outline-danger rounded-pill px-4">
                        <i class="bi bi-trash me-2"></i> Trash Bin
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Path Branding / Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-white p-3 rounded-3 border shadow-sm mb-0">
            <li class="breadcrumb-item"><a href="/godms/doc" class="text-decoration-none">
                <i class="bi bi-house-door-fill me-1"></i> Root
            </a></li>
            {{ range .breadcrumbs }}
            <li class="breadcrumb-item"><a href="/godms/doc/{{ .ID }}" class="text-decoration-none">{{ .Name }}</a></li>
            {{ end }}
        </ol>
    </nav>

    <!-- Sort Header -->
    <div class="sort-header">
        <div class="selection-indicator me-1" onclick="toggleSelectAll(this, event, 'folder')"></div>
        Name <div class="sort-icon"><i class="bi bi-arrow-up"></i></div>
    </div>

    <!-- Folder Grid -->
    <div class="folder-grid">
        {{ range .folders }}
        <div class="folder-card item-card" data-type="folder" data-id="{{ .ID }}" data-name="{{ .Name }}" onclick="toggleSelect(this, event)" ondblclick="window.location.href='/godms/doc/{{ .ID }}'">
            <div class="selection-indicator"></div>
            <i class="bi bi-folder-fill folder-icon-img"></i>
            <span class="folder-name-text">{{ .Name }}</span>
            <div class="dropdown" onclick="event.stopPropagation()">
                <button class="btn btn-link text-secondary p-0" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                    <li><button class="dropdown-item" onclick="openRenameModal('folder', '{{ .ID }}', '{{ .Name }}')"><i class="bi bi-pencil me-2"></i> Rename</button></li>
                    <li><button class="dropdown-item text-danger" onclick="moveToTrash('folder', '{{ .ID }}')"><i class="bi bi-trash me-2"></i> Move to trash</button></li>
                </ul>
            </div>
        </div>
        {{ end }}
    </div>

    <h4 class="fw-bold mb-3" style="font-size: 1.1rem; color: #1e293b;">Files</h4>
    <div class="file-list-card">
        <div class="table-responsive">
            <table class="table file-table mb-0">
                <thead>
                    <tr>
                        <th style="width: 40px;"><div class="selection-indicator" onclick="toggleSelectAll(this, event, 'file')"></div></th>
                        <th style="width: 50%;">Name</th>
                        <th>Size</th>
                        <th>Modified</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .files }}
                    <tr class="file-row item-card" data-type="file" data-id="{{ .ID }}" data-name="{{ .Name }}" data-path="{{ .FilePath }}" onclick="toggleSelect(this, event)">
                        <td><div class="selection-indicator"></div></td>
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <i class="bi bi-file-earmark-text file-icon"></i>
                                <span class="fw-semibold {{ if eq .Extension "pdf" }}text-primary{{ end }}" 
                                      style="{{ if eq .Extension "pdf" }}cursor: pointer; text-decoration: underline;{{ end }}"
                                      onclick="{{ if eq .Extension "pdf" }}event.stopPropagation(); previewPDF('{{ .FilePath }}', '{{ .Name }}'){{ end }}">
                                    {{ .Name }}
                                </span>
                            </div>
                        </td>
                        <td class="text-muted">{{ .Size }} bytes</td>
                        <td class="text-muted">{{ .CreatedAt.Format "02 Jan 2006" }}</td>
                        <td class="text-end">
                            <div class="dropdown" onclick="event.stopPropagation()">
                                <button class="btn btn-link text-secondary p-0" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                    {{ if eq .Extension "pdf" }}
                                    <li><button class="dropdown-item" onclick="previewPDF('{{ .FilePath }}', '{{ .Name }}')"><i class="bi bi-eye me-2"></i> Preview</button></li>
                                    {{ end }}
                                    <li><button class="dropdown-item" onclick="window.open('{{ .FilePath }}', '_blank')"><i class="bi bi-download me-2"></i> Open/Download</button></li>
                                    <li><button class="dropdown-item" onclick="openRenameModal('file', '{{ .ID }}', '{{ .Name }}')"><i class="bi bi-pencil me-2"></i> Rename</button></li>
                                    <li><button class="dropdown-item text-danger" onclick="moveToTrash('file', '{{ .ID }}')"><i class="bi bi-trash me-2"></i> Move to trash</button></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {{ else }}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">No files found</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Bulk Action Bar -->
<div id="bulkActionBar" class="action-bar-fixed">
    <div class="d-flex align-items-center gap-3 me-2">
        <button class="btn btn-link text-white p-0" onclick="deselectAll()"><i class="bi bi-x-lg"></i></button>
        <span id="bulkSelectedCount" class="fw-semibold text-white">1 selected</span>
    </div>
    <div class="vr opacity-25 text-white"></div>
    <div class="d-flex align-items-center gap-3">
        <button class="action-btn-bulk" onclick="handleBulkAction('download')">
            <i class="bi bi-download"></i> Download
        </button>
        <button class="action-btn-bulk" onclick="handleBulkAction('rename')">
            <i class="bi bi-pencil"></i> Rename
        </button>
        <button class="action-btn-bulk" onclick="handleBulkAction('move')">
            <i class="bi bi-folder-symlink"></i> Move
        </button>
        <button class="action-btn-bulk text-danger" onclick="handleBulkAction('trash')">
            <i class="bi bi-trash"></i> Move to trash
        </button>
    </div>
</div>

<!-- Hidden Inputs for Upload -->
<form id="uploadFileForm" action="/godms/file/upload" method="POST" enctype="multipart/form-data" style="display: none;">
    <input type="file" id="fileInput" name="file" onchange="this.form.submit()" multiple>
    {{ if .currentFolder }}<input type="hidden" name="folder_id" value="{{ .currentFolder.ID }}">{{ end }}
</form>

<form id="uploadFolderForm" action="/godms/folder/upload" method="POST" enctype="multipart/form-data" style="display: none;">
    <input type="file" id="folderInput" name="files" webkitdirectory directory multiple onchange="this.form.submit()">
    {{ if .currentFolder }}<input type="hidden" name="folder_id" value="{{ .currentFolder.ID }}">{{ end }}
</form>

<!-- Modal Rename -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Rename</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="renameForm" method="POST">
                <input type="hidden" name="id" id="renameId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted">New Name</label>
                        <input type="text" name="name" id="renameName" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Tambah Folder -->
<div class="modal fade" id="addFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/godms/folder/store" method="POST">
                {{ if .currentFolder }}<input type="hidden" name="parent_id" value="{{ .currentFolder.ID }}">{{ end }}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted">Folder Name</label>
                        <input type="text" name="name" class="form-control" placeholder="Untitled Folder" required>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Folder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Move -->
<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Move to...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="modal-breadcrumb p-3 border-bottom bg-light d-flex gap-2 align-items-center" id="moveModalBreadcrumb" style="font-size: 0.85rem;">
                    <!-- Breadcrumbs will be here -->
                </div>
                <div class="list-group list-group-flush" id="folderListContainer" style="max-height: 400px; overflow-y: auto;">
                    <!-- Folder list populated by JS -->
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmMoveBtn" disabled>Move Here</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview PDF -->
<div class="modal fade" id="previewPdfModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="height: 90vh;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="previewPdfTitle">Preview PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="previewPdfFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<style>
    .folder-item-move {
        cursor: pointer;
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s;
    }
    .folder-item-move:hover {
        background: #f8fafc;
    }
    .folder-item-move.selected {
        background: #eff6ff;
        box-shadow: inset 4px 0 0 var(--dms-accent);
    }
    .folder-item-move .enter-chevron {
        color: #94a3b8;
        padding: 0.25rem;
        border-radius: 4px;
    }
    .folder-item-move .enter-chevron:hover {
        background: rgba(0,0,0,0.05);
        color: var(--dms-accent);
    }
    .breadcrumb-item-modal {
        cursor: pointer;
        color: var(--dms-accent);
    }
    .breadcrumb-item-modal:hover {
        text-decoration: underline;
    }
    .breadcrumb-item-modal.active {
        color: #64748b;
        cursor: default;
        text-decoration: none;
    }
</style>

<script>
    let selectedItems = [];

    function toggleSelect(element, event) {
        event.stopPropagation();
        
        element.classList.toggle('selected');
        const id = element.dataset.id;
        const type = element.dataset.type;
        const name = element.dataset.name;

        if (element.classList.contains('selected')) {
            // Check if already in list to avoid duplicates
            if (!selectedItems.find(item => item.id === id)) {
                selectedItems.push({ id, type, name });
            }
        } else {
            selectedItems = selectedItems.filter(item => item.id !== id);
        }
        
        updateActionBar();
    }

    function deselectAll() {
        document.querySelectorAll('.item-card').forEach(el => el.classList.remove('selected'));
        selectedItems = [];
        updateActionBar();
    }

    function updateActionBar() {
        const bar = document.getElementById('bulkActionBar');
        const countText = document.getElementById('bulkSelectedCount');
        if (!bar) return; // Silent return if bar is hidden (e.g., in Trash Bin)

        if (selectedItems.length > 0) {
            bar.classList.add('active');
            countText.innerText = `${selectedItems.length} selected`;
        } else {
            bar.classList.remove('active');
        }
    }

    function toggleSelectAll(checkbox, event, type) {
        event.stopPropagation();
        checkbox.classList.toggle('selected');
        const isAllSelected = checkbox.classList.contains('selected');
        
        let selector = '.item-card';
        if (type === 'folder') selector = '.folder-card.item-card';
        else if (type === 'file') selector = '.file-row.item-card';
        
        const targetItems = document.querySelectorAll(selector);
        
        targetItems.forEach(el => {
            const id = el.dataset.id;
            if (isAllSelected) {
                if (!el.classList.contains('selected')) {
                    el.classList.add('selected');
                    selectedItems.push({
                        id: id,
                        type: el.dataset.type,
                        name: el.dataset.name
                    });
                }
            } else {
                if (el.classList.contains('selected')) {
                    el.classList.remove('selected');
                    selectedItems = selectedItems.filter(item => item.id !== id);
                }
            }
        });
        
        updateActionBar();
    }

    function deletePermanently(type, id) {
        if (confirm('Are you sure you want to delete this permanently? This action cannot be undone.')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/godms/${type}/delete-permanent`;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'id';
            input.value = id;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function restoreItem(type, id) {
        if (confirm('Restore this item to its original location?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/godms/${type}/restore`;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'id';
            input.value = id;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function openRenameModal(type, id, name) {
        const modal = new bootstrap.Modal(document.getElementById('renameModal'));
        document.getElementById('renameId').value = id;
        document.getElementById('renameName').value = name;
        document.getElementById('renameForm').action = `/godms/${type}/rename`;
        modal.show();
    }

    function moveToTrash(type, id) {
        if (confirm('Move to trash bin?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/godms/${type}/trash`;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'id';
            input.value = id;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function handleBulkAction(action) {
        if (selectedItems.length === 0) return;
        if (action === 'rename') {
            const item = selectedItems[0];
            openRenameModal(item.type, item.id, item.name);
        } else if (action === 'trash') {
            if (confirm(`Move ${selectedItems.length} items to trash?`)) {
                const formData = new URLSearchParams();
                selectedItems.forEach(item => {
                    if (item.type === 'folder') {
                        formData.append('folder_ids[]', item.id);
                    } else {
                        formData.append('file_ids[]', item.id);
                    }
                });

                fetch('/godms/bulk-trash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                }).then(res => {
                    if (res.ok) window.location.reload();
                    else alert('Failed to move items to trash');
                });
            }
        } else if (action === 'download') {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/godms/bulk-download';
            
            selectedItems.forEach(item => {
                const input = document.createElement('input');
                input.type = 'hidden';
                if (item.type === 'folder') {
                    input.name = 'folder_ids[]';
                } else {
                    input.name = 'file_ids[]';
                }
                input.value = item.id;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        } else if (action === 'move') {
            openMoveModal();
        }
    }

    function previewPDF(path, name) {
        const modal = new bootstrap.Modal(document.getElementById('previewPdfModal'));
        document.getElementById('previewPdfTitle').innerText = name;
        document.getElementById('previewPdfFrame').src = path;
        modal.show();
        
        // Clear src when hidden
        document.getElementById('previewPdfModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('previewPdfFrame').src = '';
        }, { once: true });
    }

    let targetMoveFolderId = null;
    let allFoldersCache = [];
    let modalFolderHistory = [{ id: '', name: 'Root' }];

    function openMoveModal() {
        const modal = new bootstrap.Modal(document.getElementById('moveModal'));
        modalFolderHistory = [{ id: '', name: 'Root' }];
        loadFoldersForMove();
        modal.show();
    }

    async function loadFoldersForMove() {
        const container = document.getElementById('folderListContainer');
        container.innerHTML = '<div class="p-4 text-center text-muted">Loading...</div>';
        
        try {
            if (allFoldersCache.length === 0) {
                const response = await fetch('/godms/folder-list');
                allFoldersCache = await response.json();
            }
            renderFoldersByParent('');
        } catch (err) {
            container.innerHTML = '<div class="p-4 text-center text-danger">Failed to load folders</div>';
        }
    }

    function updateMoveModalBreadcrumbs() {
        const breadcrumb = document.getElementById('moveModalBreadcrumb');
        breadcrumb.innerHTML = '';
        
        modalFolderHistory.forEach((folder, index) => {
            if (index > 0) breadcrumb.innerHTML += '<i class="bi bi-chevron-right text-muted small mx-1"></i>';
            
            const span = document.createElement('span');
            span.className = `breadcrumb-item-modal ${index === modalFolderHistory.length - 1 ? 'active fw-bold' : ''}`;
            span.innerText = folder.name;
            if (index < modalFolderHistory.length - 1) {
                span.onclick = () => {
                    modalFolderHistory = modalFolderHistory.slice(0, index + 1);
                    renderFoldersByParent(folder.id);
                };
            }
            breadcrumb.appendChild(span);
        });
    }

    function renderFoldersByParent(parentId) {
        const container = document.getElementById('folderListContainer');
        container.innerHTML = '';
        updateMoveModalBreadcrumbs();
        
        // Add "Back" option if not at Root
        if (modalFolderHistory.length > 1) {
            const backItem = document.createElement('div');
            backItem.className = 'folder-item-move bg-light text-muted';
            backItem.style.fontSize = '0.85rem';
            backItem.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-arrow-left"></i>
                    <span>Kembali ke folder sebelumnya</span>
                </div>
            `;
            backItem.onclick = () => {
                modalFolderHistory.pop();
                const newParent = modalFolderHistory[modalFolderHistory.length - 1];
                renderFoldersByParent(newParent.id);
            };
            container.appendChild(backItem);
        }

        // Filter folders for current parent
        const children = allFoldersCache.filter(f => (f.ParentID || '') === parentId);
        
        if (children.length === 0 && parentId !== '') {
            container.innerHTML = '<div class="p-4 text-center text-muted">Folder ini kosong</div>';
        }

        children.forEach(folder => {
            // Skip currently selected folders to avoid circular move
            if (selectedItems.find(item => item.type === 'folder' && item.id === folder.ID)) {
                return;
            }

            const item = document.createElement('div');
            item.className = 'folder-item-move';
            item.onclick = () => selectMoveFolder(folder.ID, item);
            item.ondblclick = (e) => {
                e.stopPropagation();
                modalFolderHistory.push({ id: folder.ID, name: folder.Name });
                renderFoldersByParent(folder.ID);
            };
            
            const leftPart = document.createElement('div');
            leftPart.className = 'd-flex align-items-center gap-3';
            leftPart.innerHTML = `<i class="bi bi-folder-fill text-warning"></i> <span>${folder.Name}</span>`;
            
            const rightPart = document.createElement('div');
            const hasChildren = allFoldersCache.some(f => f.ParentID === folder.ID);
            if (hasChildren) {
                rightPart.innerHTML = '<i class="bi bi-chevron-right enter-chevron"></i>';
                rightPart.onclick = (e) => {
                    e.stopPropagation();
                    modalFolderHistory.push({ id: folder.ID, name: folder.Name });
                    renderFoldersByParent(folder.ID);
                };
            }

            item.appendChild(leftPart);
            item.appendChild(rightPart);
            container.appendChild(item);
        });

        document.getElementById('confirmMoveBtn').disabled = false;
        targetMoveFolderId = parentId;
    }

    function selectMoveFolder(id, element) {
        document.querySelectorAll('.folder-item-move').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        targetMoveFolderId = id;
    }

    document.getElementById('confirmMoveBtn').onclick = async function() {
        const formData = new URLSearchParams();
        formData.append('target_id', targetMoveFolderId);
        
        selectedItems.forEach(item => {
            if (item.type === 'folder') {
                formData.append('folder_ids[]', item.id);
            } else {
                formData.append('file_ids[]', item.id);
            }
        });

        try {
            const response = await fetch('/godms/bulk-move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to move items');
            }
        } catch (err) {
            alert('Error moving items');
        }
    };

    // Drag & Drop Handling
    const dropOverlay = document.getElementById('dropOverlay');
    const uploadProgressContainer = document.getElementById('uploadProgressContainer');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    let dragCounter = 0;

    window.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        if (dragCounter === 1) dropOverlay.classList.add('active');
    });

    window.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        if (dragCounter === 0) dropOverlay.classList.remove('active');
    });

    window.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    window.addEventListener('drop', async (e) => {
        e.preventDefault();
        dragCounter = 0;
        dropOverlay.classList.remove('active');

        // Only allow drop

        const items = e.dataTransfer.items;
        if (items) {
            const formData = new FormData();
            {{ if .currentFolder }}
            formData.append('folder_id', '{{ .currentFolder.ID }}');
            {{ end }}
            
            const entries = [];
            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) entries.push(item);
            }

            if (entries.length > 0) {
                dropOverlay.classList.add('active');
                dropOverlay.querySelector('h2').innerText = 'Processing files...';
                
                await processEntries(entries, formData);
                
                dropOverlay.querySelector('h2').innerText = 'Uploading...';
                uploadProgressContainer.style.display = 'block';
                
                uploadWithProgress(formData);
            }
        }
    });

    async function processEntries(entries, formData, path = '') {
        for (const entry of entries) {
            if (entry.isFile) {
                const file = await new Promise((resolve) => entry.file(resolve));
                const relativePath = path ? `${path}/${file.name}` : file.name;
                // Using 'files' field for UploadFolder handler compatibility
                formData.append('files', file, relativePath);
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const dirEntries = await new Promise((resolve) => {
                    let allEntries = [];
                    function read() {
                        reader.readEntries(entries => {
                            if (entries.length) {
                                allEntries = allEntries.concat(entries);
                                read();
                            } else {
                                resolve(allEntries);
                            }
                        });
                    }
                    read();
                });
                await processEntries(dirEntries, formData, path ? `${path}/${entry.name}` : entry.name);
            }
        }
    }

    function uploadWithProgress(formData) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/godms/folder/upload', true);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                uploadProgressBar.style.width = percent + '%';
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200 || xhr.status === 303 || xhr.status === 302) {
                window.location.reload();
            } else {
                alert('Upload failed: ' + xhr.statusText);
                dropOverlay.classList.remove('active');
                uploadProgressContainer.style.display = 'none';
            }
        };

        xhr.onerror = () => {
            alert('Upload error');
            dropOverlay.classList.remove('active');
            uploadProgressContainer.style.display = 'none';
        };

        xhr.send(formData);
    }
</script>
{{ end }}
